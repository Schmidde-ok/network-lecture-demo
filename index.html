<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Instructor Tool: Manual OSI Flow</title>
    <style>
        :root { --app: #ff6b6b; --trans: #4ecdc4; --net: #45b7d1; --link: #96ceb4; --phys: #ffeead; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .topology { display: flex; align-items: center; justify-content: space-around; width: 950px; height: 160px; background: white; border-radius: 12px; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
        .wire-bg { position: absolute; top: 50%; left: 10%; right: 10%; height: 4px; background: #bdc3c7; z-index: 1; }
        .node { width: 100px; height: 100px; background: var(--dark); color: white; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 0.85em; z-index: 2; border: 4px solid transparent; transition: 0.3s; }
        .router-node { border-radius: 50%; width: 110px; height: 110px; }
        .active-node { border-color: #f39c12; box-shadow: 0 0 20px #f39c12; transform: scale(1.05); }
        #inspector { width: 950px; background: white; border-radius: 10px; padding: 20px; border-top: 8px solid var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .status-area { text-align: center; margin-bottom: 20px; height: 80px; }
        .pdu-title { font-size: 1.5em; font-weight: bold; color: #2980b9; }
        .header-stack { display: flex; justify-content: center; align-items: center; gap: 8px; min-height: 60px; }
        .header-block { padding: 12px 18px; border: 2px solid #333; border-radius: 5px; font-weight: bold; animation: popIn 0.4s ease-out; }
        .controls { margin-top: 30px; display: flex; gap: 10px; }
        button { padding: 15px 30px; font-size: 1.2em; background: var(--dark); color: white; border: none; border-radius: 8px; cursor: pointer; }
        #stepBtn { background: #27ae60; display: none; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <h1>Chapter 1: Network Flow Control</h1>
    <div class="topology">
        <div class="wire-bg"></div>
        <div class="node" id="node-pc"><strong>SENDER</strong></div>
        <div class="node" id="node-sw"><strong>SWITCH</strong></div>
        <div class="node router-node" id="node-rt"><strong>ROUTER</strong></div>
        <div class="node" id="node-srv"><strong>RECEIVER</strong></div>
    </div>
    <div id="inspector">
        <div class="status-area">
            <div id="pdu-name" class="pdu-title">Manual Mode</div>
            <div id="pdu-action">Click "Start" to begin, then use "Next Step" to lecture.</div>
        </div>
        <div class="header-stack" id="packet-container"></div>
    </div>
    <div class="controls">
        <button id="runBtn" onclick="initDemo()">Start New Demo</button>
        <button id="stepBtn" onclick="resolveStep()">Next Step &rarr;</button>
    </div>

    <script>
        let stepResolver;
        const layers = {
            7: { n: 'Data', p: 'DATA', c: 'var(--app)', i: 'Application Payload' },
            4: { n: 'L4 Header', p: 'SEGMENT', c: 'var(--trans)', i: 'TCP Port Added' },
            3: { n: 'L3 Header', p: 'PACKET', c: 'var(--net)', i: 'IP Address Added' },
            2: { n: 'L2 Header', p: 'FRAME', c: 'var(--link)', i: 'MAC Address Added' }
        };

        function resolveStep() { if (stepResolver) stepResolver(); }
        async function waitForClick() { return new Promise(res => { stepResolver = res; }); }

        async function initDemo() {
            document.getElementById('runBtn').style.display = 'none';
            document.getElementById('stepBtn').style.display = 'inline-block';
            document.getElementById('packet-container').innerHTML = '';
            
            // SENDER
            setNode('node-pc');
            for (let l of [7, 4, 3, 2]) {
                updateUI(layers[l].p, `Sender: Adding ${layers[l].n}`);
                const div = document.createElement('div');
                div.className = 'header-block'; div.id = 'block-' + l;
                div.style.background = layers[l].c; div.innerText = layers[l].n;
                document.getElementById('packet-container').insertBefore(div, document.getElementById('packet-container').firstChild);
                await waitForClick();
            }

            // SWITCH
            setNode('node-sw');
            updateUI('FRAME', "Switch: Reading MAC Address (L2). Packet remains sealed.");
            await waitForClick();

            // ROUTER
            setNode('node-rt');
            updateUI('PACKET', "Router: Stripping L2 Frame to see L3 IP Address.");
            document.getElementById('block-2').style.opacity = '0.1';
            await waitForClick();

            updateUI('FRAME', "Router: Re-wrapping with NEW L2 Header for LAN B.");
            document.getElementById('block-2').style.opacity = '1';
            document.getElementById('block-2').innerText = "New L2 Header";
            await wait(200);
            await waitForClick();

            // RECEIVER
            setNode('node-srv');
            for (let l of [2, 3, 4]) {
                updateUI(layers[l].p, `Receiver: Stripping ${layers[l].n}`);
                document.getElementById('block-' + l).remove();
                await waitForClick();
            }

            updateUI('DATA', "Success! Message Delivered.");
            document.getElementById('runBtn').style.display = 'inline-block';
            document.getElementById('stepBtn').style.display = 'none';
        }

        function setNode(id) {
            document.querySelectorAll('.node').forEach(n => n.classList.remove('active-node'));
            document.getElementById(id).classList.add('active-node');
        }
        function updateUI(p, a) {
            document.getElementById('pdu-name').innerText = "PDU: " + p;
            document.getElementById('pdu-action').innerText = a;
        }
    </script>
</body>
</html>
